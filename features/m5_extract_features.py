# ğŸ“œ features/m5_extract_features.py
# ğŸ§  [ëª¨ë“ˆ 5] íŠ¹ì§• ì¶”ì¶œ ë§¤ë‹ˆì € (Manager)
# M4ì—ì„œ ë°›ì€ Epochs ê°ì²´ë¥¼ ìˆœíšŒí•˜ë©° A, B, C íŠ¹ì§•ì„ ì¶”ì¶œí•˜ë„ë¡ ì§€ì‹œí•©ë‹ˆë‹¤.

import mne
import config
import numpy as np

# --- 1. ê° íŠ¹ì§•ë³„ 'ì¼ê¾¼' í•¨ìˆ˜ë“¤ì„ ì„í¬íŠ¸í•©ë‹ˆë‹¤ ---
# (ì´ íŒŒì¼ë“¤ì€ ì•„ì§ ìƒì„± ì „ì´ì§€ë§Œ, ê³§ ë§Œë“¤ íŒŒì¼ë“¤ì…ë‹ˆë‹¤.)
# ì´ í•¨ìˆ˜ë“¤ì€ (epoch_data, cfg, kpi_row)ë¥¼ ì¸ìˆ˜ë¡œ ë°›ì•„,
# kpi_row ë”•ì…”ë„ˆë¦¬ì— ê³„ì‚°ëœ KPI ê°’ë“¤ì„ 'ì±„ì›Œ ë„£ëŠ”' ì—­í• ì„ í•©ë‹ˆë‹¤.
from .features_A import get_A_features
from .features_B import get_B_features
from .features_C import get_C_features


def extract_features_from_epochs(epochs_A: mne.Epochs, epochs_BC: mne.Epochs, cfg: config) -> list:
    """
    [M5] M4ì—ì„œ ë°›ì€ 'A' Epochsì™€ 'B/C' Epochsë¥¼ ìˆœíšŒí•˜ë©°
    features_A, B, C íŒŒì¼ì— ìˆëŠ” í•¨ìˆ˜ë“¤ì„ í˜¸ì¶œí•˜ì—¬ ëª¨ë“  KPIë¥¼ ì¶”ì¶œí•©ë‹ˆë‹¤.

    Args:
        epochs_A (mne.Epochs): A ìœ í˜• (í˜•íƒœí•™ì ) Epochs ê°ì²´
        epochs_BC (mne.Epochs): B/C ìœ í˜• (ì£¼íŒŒìˆ˜/ë¹„ì„ í˜•) Epochs ê°ì²´
        cfg (config): config.py ëª¨ë“ˆ ê°ì²´

    Returns:
        list: ê° Epochì˜ KPIê°€ ë‹´ê¸´ ë”•ì…”ë„ˆë¦¬ë“¤ì˜ ë¦¬ìŠ¤íŠ¸
              (ì´ ë¦¬ìŠ¤íŠ¸ê°€ ìµœì¢… CSV íŒŒì¼ì˜ ë‚´ìš©ì´ ë©ë‹ˆë‹¤.)
    """
    
    print(f"[M5] í•µì‹¬ ë³€ìˆ˜ ì¶”ì¶œ(KPI) ì‹œì‘...")
    all_kpi_rows = [] # ìµœì¢… CSV íŒŒì¼ì´ ë  ë”•ì…”ë„ˆë¦¬ ë¦¬ìŠ¤íŠ¸

    # --- A. 'ì²« ëŒ€ë©´' (í˜•íƒœí•™ì /ì‹œê°„ì¶•) Epoch ì²˜ë¦¬ ---
    if epochs_A is not None:
        # .get_data()ëŠ” (n_epochs, n_channels, n_samples) 3D ë°°ì—´ì„ ë°˜í™˜í•©ë‹ˆë‹¤.
        # (ì˜ˆ: 20ê°œ Epochs, 2ê°œ ì±„ë„, 1000ê°œ ìƒ˜í”Œ)
        all_data_A = epochs_A.get_data(picks='eeg')
        
        # (n_epochs) ë§Œí¼ ë°˜ë³µ
        for i in range(len(all_data_A)):
            # (n_channels, n_samples) 2D ë°°ì—´ì„ í•¨ìˆ˜ì— ì „ë‹¬
            epoch_data = all_data_A[i] 
            
            # CSVì˜ í•œ 'í–‰(row)'ì´ ë  ê¸°ë³¸ ë”•ì…”ë„ˆë¦¬ ìƒì„±
            kpi_row = {
                'epoch_id': f"A_{i}",          # Epoch ì‹ë³„ì (Aíƒ€ì…, 0ë²ˆì§¸)
                'epoch_type': 'A_first_glimpse'
            }
            
            # features_A.pyì˜ í•¨ìˆ˜ê°€ ì´ ë”•ì…”ë„ˆë¦¬ë¥¼ ë°›ì•„ KPIë¥¼ ì±„ì›Œë„£ìŒ
            try:
                get_A_features(epoch_data, cfg, kpi_row)
                all_kpi_rows.append(kpi_row)
            except Exception as e:
                print(f"[ERROR M5-A] 'A' Epoch {i} ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜: {e}")

    
    # --- B/C. 'ì—°ì† ê±°ë‹ê¸°' (ì£¼íŒŒìˆ˜/ë¹„ì„ í˜•) Epoch ì²˜ë¦¬ ---
    if epochs_BC is not None:
        # (n_epochs, n_channels, n_samples) 3D ë°°ì—´ ë°˜í™˜
        all_data_BC = epochs_BC.get_data(picks='eeg')
        
        # (n_epochs) ë§Œí¼ ë°˜ë³µ
        for i in range(len(all_data_BC)):
            # (n_channels, n_samples) 2D ë°°ì—´ ì „ë‹¬
            epoch_data = all_data_BC[i]
            
            kpi_row = {
                'epoch_id': f"BC_{i}",         # Epoch ì‹ë³„ì (BCíƒ€ì…, 0ë²ˆì§¸)
                'epoch_type': 'BC_judgment'
            }
            
            # features_B.pyì™€ features_C.pyì˜ í•¨ìˆ˜ê°€ ì´ ë”•ì…”ë„ˆë¦¬ë¥¼ ì±„ì›Œë„£ìŒ
            try:
                # 1. ì£¼íŒŒìˆ˜ì¶• ë³€ìˆ˜(B) ê³„ì‚°
                get_B_features(epoch_data, cfg, kpi_row)
                # 2. ë™ì /ë¹„ì„ í˜• ë³€ìˆ˜(C) ê³„ì‚°
                get_C_features(epoch_data, cfg, kpi_row)
                
                all_kpi_rows.append(kpi_row)
            except Exception as e:
                print(f"[ERROR M5-BC] 'B/C' Epoch {i} ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜: {e}")

    print(f"[M5] KPI ì¶”ì¶œ ì™„ë£Œ: ì´ {len(all_kpi_rows)}ê°œì˜ ìœ íš¨ Epoch ì²˜ë¦¬.")
    return all_kpi_rows